# jsonl2html/convert.py

## Назначение

Этот скрипт предназначен для преобразования файлов формата JSONL (JSON Lines) в единый, самодостаточный HTML-файл. Полученный HTML-файл позволяет удобно просматривать и анализировать данные из JSONL в браузере, предоставляя интерактивный интерфейс для навигации по записям.

## Основные компоненты

### Классы

#### `ExceptionFileInput(Exception)`
Специализированное исключение, которое выбрасывается при возникновении проблем с входным JSONL-файлом, таких как ошибки чтения, неверный формат JSON или отсутствие файла.

#### `JSONLToHTMLConverter`
Основной класс, инкапсулирующий всю логику конвертации.

**Атрибуты класса:**
- `fn_template (Path)`: Путь к файлу HTML-шаблона, который используется для генерации конечного файла.
- `list_auto_columns (List[str])`: Список имен столбцов (`['question', 'quesitions', 'prompt', 'prompts']`), которые автоматически ищутся для создания индекса, если `index_column` установлен в `'auto'`.
- `max_lines (int)`: Максимальное количество строк (записей), считываемых из JSONL-файла. По умолчанию `10000`.

**Методы экземпляра:**
- `__init__(self, fn_input: str, fn_output: str, index_column: Optional[str], additional_table_content: Optional[str])`: Конструктор класса. Инициализирует пути к входному и выходному файлам, а также параметры для индексации и дополнительного содержания.
- `run(self)`: Основной метод, запускающий процесс конвертации. Он читает данные, обрабатывает их, генерирует HTML и сохраняет результат в файл.
- `read_jsonl(cls, fn: str) -> List[Dict]`: Статический метод для чтения и парсинга JSONL-файла. Возвращает список словарей.
- `get_auto_index_column(cls, first_row: Dict) -> Optional[str]`: Статический метод для автоматического определения столбца для индекса на основе первой записи в данных.
- `add_index(data: List[Dict], index_column: str) -> None`: Статический метод для добавления специального поля `__index__` к каждой записи. Это поле используется для создания оглавления в HTML-файле.

### Функции

#### `convert_jsonl_to_html(fn_input: str, index_column: Optional[str] = 'auto', fn_output: str = "auto", additional_table_content: Optional[str] = None) -> None`
Публичная функция-обертка, которая создает экземпляр `JSONLToHTMLConverter` и запускает его. Это основной интерфейс для использования конвертера как из других Python-скриптов, так и через командную строку.

#### `main_bash_entry_point()`
Точка входа для интерфейса командной строки (CLI). Использует библиотеку `fire` для предоставления CLI на основе функции `convert_jsonl_to_html`.

## Зависимости

- `json`: Для сериализации и десериализации данных в формате JSON.
- `sys`: Используется для завершения работы скрипта с кодом ошибки при отсутствии обязательных аргументов.
- `base64`: Для кодирования данных JSONL в строку Base64, которая встраивается непосредственно в HTML-файл.
- `typing`: Для статической типизации и улучшения читаемости кода (`Union`, `Optional`, `List`, `Dict`).
- `fire`: Для автоматического создания интерфейса командной строки (CLI) из функций Python.
- `pathlib.Path`: Для объектно-ориентированной работы с путями файловой системы, что делает код кросс-платформенным.
- `logging`: Для вывода информационных сообщений, предупреждений и ошибок в ходе выполнения.
- `.create_table_of_content.create_table_of_content_unicode_stats`: Локальный импорт для генерации статистики по Unicode-символам в данных, которая добавляется в оглавление.

## Архитектурные решения

- **Объектно-ориентированный подход**: Основная логика вынесена в класс `JSONLToHTMLConverter`, что позволяет сгруппировать связанные данные (пути к файлам, параметры) и поведение (чтение, обработка, запись).
- **Шаблонизация**: Генерация HTML происходит на основе внешнего файла-шаблона (`html_template.html`). Данные вставляются в шаблон путем замены строки-плейсхолдера (`BASE64STRING`) на закодированные данные. Это разделяет логику обработки данных и их представление.
- **Самодостаточный HTML**: Весь набор данных из JSONL-файла кодируется в Base64 и встраивается в один HTML-файл. Это делает результат полностью портативным: для просмотра не требуется ничего, кроме браузера, и нет зависимостей от внешних файлов данных.
- **Автоматизация CLI**: Библиотека `fire` используется для быстрого создания мощного интерфейса командной строки без написания кода для парсинга аргументов.
- **Гибкая конфигурация**: Предусмотрены "умные" значения по умолчанию, такие как автоматическое определение имени выходного файла (`fn_output='auto'`) и столбца для индекса (`index_column='auto'`), что упрощает использование.
- **Отказоустойчивость**: Код включает обработку исключений для операций с файлами и парсинга JSON, а также использует `logging` для информирования пользователя о ходе процесса и возможных проблемах.

## API/Интерфейсы

### Программный интерфейс (Python)

Основной публичной функцией для использования в других модулях является `convert_jsonl_to_html`.

**Сигнатура:**
```python
def convert_jsonl_to_html(
    fn_input: str, 
    index_column: Optional[str] = 'auto', 
    fn_output: str = "auto", 
    additional_table_content: Optional[str] = None
) -> None
```
**Параметры:**
- `fn_input (str)`: **Обязательный.** Путь к входному файлу `.jsonl`.
- `index_column (Optional[str])`: Имя столбца, который будет использоваться для создания оглавления.
  - `'auto'` (по умолчанию): Автоматически ищет столбцы из списка `['question', 'prompt', ...]`.
  - `None`: Отключает создание оглавления.
  - `<имя_столбца>`: Явно указывает столбец для индекса.
- `fn_output (str)`: Путь к выходному файлу `.html`.
  - `'auto'` (по умолчанию): Имя файла генерируется на основе имени `fn_input` (например, `data.jsonl` -> `data.html`).
- `additional_table_content (Optional[str])`: Словарь для добавления дополнительной информации в оглавление.

### Интерфейс командной строки (CLI)

Скрипт можно вызывать из командной строки.

**Формат вызова:**
```bash
python -m jsonl2html.convert <fn_input> [флаги]
```
или если установлен как пакет:
```bash
jsonl2html <fn_input> [флаги]
```

**Аргументы и флаги:**
- `fn_input`: **Обязательный.** Путь к входному файлу `.jsonl`.
- `--index_column`: Столбец для индексации (по умолчанию `'auto'`).
- `--fn_output`: Путь к выходному файлу (по умолчанию `'auto'`).

## Примеры использования

### Использование в Python-скрипте

```python
from jsonl2html.convert import convert_jsonl_to_html

# Пример 1: Простая конвертация с автоматическими настройками
convert_jsonl_to_html("my_data.jsonl")
# Результат: будет создан файл my_data.html

# Пример 2: Указание выходного файла и столбца для индекса
convert_jsonl_to_html(
    fn_input="my_data.jsonl",
    fn_output="report.html",
    index_column="prompt"
)
# Результат: будет создан файл report.html с оглавлением по полю 'prompt'

# Пример 3: Конвертация без оглавления
convert_jsonl_to_html(
    fn_input="my_data.jsonl",
    index_column=None
)
```

### Использование из командной строки

```bash
# Простая конвертация
jsonl2html path/to/data.jsonl

# Указание имени выходного файла
jsonl2html path/to/data.jsonl --fn_output my_report.html

# Явное указание столбца для оглавления
jsonl2html path/to/data.jsonl --index_column="prompt"

# Отключение оглавления
jsonl2html path/to/data.jsonl --index_column=None
```