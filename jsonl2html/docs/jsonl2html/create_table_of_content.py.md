# jsonl2html/create_table_of_content.py

## Назначение

Этот модуль предназначен для анализа файла в формате JSONL, содержащего статистику по использованию символов Unicode. Он генерирует сводную информацию и оглавление в виде набора таблиц в формате Markdown. Основная задача — выявить и сгруппировать данные по блокам Unicode, рассчитать статистику по "плохим" (нестандартным) символам и строкам и представить результаты в удобном для чтения виде, готовом для встраивания в HTML-документ.

## Основные компоненты

### Функции

-   **`list_of_str_to_links(s: str, n_max_links: int = 50) -> str`**
    Преобразует строку, содержащую JSON-массив индексов строк, в строку с Markdown-ссылками. Индексы в ссылках увеличиваются на 1 для удобства пользователя (1-based indexing). Если количество ссылок превышает `n_max_links`, список усекается, и в центре отображается многоточие.

-   **`get_unicode_small_stats(df: DataFrame) -> str`**
    Рассчитывает и форматирует в HTML краткую статистику по "плохим" строкам и символам. "Плохими" считаются строки, содержащие символы из Unicode-блоков, не входящих в предопределенный "хороший" список (`list_block_good`). Функция возвращает процент и абсолютное количество таких строк и символов.

-   **`create_table_of_content_unicode_stats(fn_input_jsonl: str) -> Dict[str, str]`**
    Основная функция модуля. Она выполняет полный цикл анализа:
    1.  Читает JSONL-файл и агрегирует статистику по блокам Unicode с помощью `unicode_stats.AggregatedUnicodeBlockParser`.
    2.  Вызывает `get_unicode_small_stats` для получения общей сводки.
    3.  Генерирует Markdown-таблицы для каждой колонки исходных данных, а также отдельные таблицы для "проблемных" блоков (`CONCERNS`) и для всех блоков с полным списком ссылок (`ALL_LINKS`).
    4.  Возвращает словарь, где ключи — это названия разделов (например, `unicode_stats`, `CONCERNS`, `имя_колонки`), а значения — сгенерированные таблицы в виде строк.

## Зависимости

-   **`json`**: Используется для парсинга JSON-строк, которые хранятся в ячейках DataFrame (например, списки номеров строк).
-   **`pandas`**: Основная библиотека для работы с данными. Статистика хранится и обрабатывается в объекте `DataFrame`.
-   **`typing`**: Используется для аннотаций типов (в частности, `Dict`).
-   **`unicode_stats.aggregation`**: Предоставляет класс `AggregatedUnicodeBlockParser` для сбора и агрегации статистики по блокам Unicode из файла JSONL.
-   **`unicode_stats.block_rules`**: Предоставляет список `list_block_good`, который используется для определения "хороших" (стандартных) блоков Unicode.

## Архитектурные решения

-   **Функциональная декомпозиция**: Логика разделена на три независимые функции с четко определенными задачами: одна для форматирования ссылок, вторая для расчета общей статистики, и третья — оркестратор, который управляет процессом анализа.
-   **Обработка данных на основе DataFrame**: Центральным элементом архитектуры является `pandas.DataFrame`. Это позволяет эффективно выполнять операции фильтрации, сортировки, группировки и агрегации данных.
-   **Отложенный импорт**: Зависимости от библиотеки `unicode_stats` импортируются непосредственно внутри функций, которые их используют. Это может быть сделано для того, чтобы сделать эту зависимость опциональной или избежать проблем с циклическими импортами. Функция `create_table_of_content_unicode_stats` явно обрабатывает `ModuleNotFoundError`, подтверждая, что `unicode_stats` может отсутствовать.
-   **Разделение данных и представления**: Функции генерируют строковое представление данных (HTML или Markdown), отделяя логику анализа от финального рендеринга, который происходит в другом месте проекта.

## API/Интерфейсы

### Публичные функции

-   **`create_table_of_content_unicode_stats(fn_input_jsonl: str) -> Dict[str, str]`**
    -   **`fn_input_jsonl` (str)**: Путь к входному файлу JSONL, содержащему статистику по символам.
    -   **Возвращает (Dict[str, str])**: Словарь, где ключи — названия секций отчета, а значения — строки с содержимым этих секций в формате Markdown или HTML.
    -   **Вызывает исключение (`ModuleNotFoundError`)**: Если не установлена необходимая зависимость `unicode_stats`.

-   **`list_of_str_to_links(s: str, n_max_links: int = 50) -> str`**
    -   **`s` (str)**: Строка, представляющая собой JSON-список целых чисел (индексов).
    -   **`n_max_links` (int, optional)**: Максимальное количество ссылок для отображения. По умолчанию 50.
    -   **Возвращает (str)**: Строка с Markdown-ссылками.

-   **`get_unicode_small_stats(df: DataFrame) -> str`**
    -   **`df` (DataFrame)**: DataFrame со статистикой, должен содержать колонки `block`, `rows`, `n_symbols`.
    -   **Возвращает (str)**: Строка в формате HTML с краткой статистикой.

## Примеры использования

Модуль предназначен для использования в качестве библиотеки. Пример вызова основной функции:

```python
# Предположим, у нас есть файл 'stats.jsonl'
# с результатами анализа символов Unicode.

from jsonl2html.create_table_of_content import create_table_of_content_unicode_stats

# Путь к файлу со статистикой
input_file = 'path/to/your/stats.jsonl'

try:
    # Генерация оглавления и таблиц
    report_parts = create_table_of_content_unicode_stats(input_file)

    # Вывод сгенерированных частей отчета
    print("--- Общая статистика ---")
    print(report_parts['unicode_stats'])

    print("\n--- Проблемные блоки (CONCERNS) ---")
    print(report_parts['CONCERNS'])

    # Вывод статистики для конкретной колонки, если она есть
    if 'text_column' in report_parts:
        print("\n--- Статистика для 'text_column' ---")
        print(report_parts['text_column'])

except FileNotFoundError:
    print(f"Ошибка: Файл не найден по пути {input_file}")
except ModuleNotFoundError:
    print("Ошибка: для выполнения анализа необходима библиотека 'unicode_stats'.")

# Структура возвращаемого словаря `report_parts` будет примерно такой:
# {
#     'unicode_stats': '<h1> Bad Rows: 0.1234% </h1> ...',
#     'CONCERNS': '| column | block | n_symbols | url |\n|---|---|---|---|\n| ... |',
#     'text_column': '| column | block | n_symbols | url |\n|---|---|---|---|\n| ... |',
#     'another_column': '| column | block | n_symbols | url |\n|---|---|---|---|\n| ... |',
#     'ALL_LINKS': '| column | block | n_symbols | url |\n|---|---|---|---|\n| ... |'
# }
```